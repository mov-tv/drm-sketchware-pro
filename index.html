<!DOCTYPE html>
<html>
<head>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Test Decryption</title>
</head>
<body>
    <script>
        // استخراج المعلمات من الرابط
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                manifest: params.get('manifest')
            };
        }

        async function fetchAndDecrypt(manifestUrl) {
            try {
                // تحقق من الرابط
                if (!manifestUrl) {
                    alert('فشل: رابط manifest غير متوفر.');
                    return;
                }
                alert('الخطوة 1: رابط manifest متوفر.');

                // إرسال الطلب
                alert('الخطوة 2: يتم الآن إرسال الطلب إلى الرابط...');
                const response = await fetch(manifestUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'okhttp/3.12.8'
                    }
                });

                if (!response.ok) {
                    alert(`فشل: الطلب لم ينجح. رمز الحالة: ${response.status}`);
                    return;
                }
                alert('الخطوة 3: الطلب نجح. تم الحصول على الاستجابة.');

                // الحصول على النص المشفر والترويسة
                const encryptedText = await response.text();
                const headerT = response.headers.get('t');
                if (!headerT) {
                    alert('فشل: الترويسة "t" غير موجودة في الاستجابة.');
                    return;
                }
                alert('الخطوة 4: الترويسة "t" متوفرة.');

                // بناء المفتاح
                const key = "c!xZj+N9&G@Ev@vw" + headerT;
                alert('الخطوة 5: المفتاح تم إنشاؤه بنجاح.');

                // فك التشفير باستخدام XOR
                alert('الخطوة 6: يتم الآن فك التشفير...');
                const decodedBytes = atob(encryptedText); // فك تشفير Base64
                const resultBytes = new Uint8Array(decodedBytes.length);
                for (let i = 0; i < decodedBytes.length; i++) {
                    resultBytes[i] = decodedBytes.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                }

                // تحويل النص المفكوك إلى صيغة نصية
                const decryptedText = new TextDecoder().decode(resultBytes);
                alert('الخطوة 7: فك التشفير تم بنجاح.');

                // عرض النص المفكوك
                alert(`النص المفكوك (JSON):\n${decryptedText}`);
            } catch (error) {
                alert(`خطأ أثناء المعالجة: ${error.message}`);
            }
        }

        // تشغيل العملية عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const { manifest } = getQueryParams();
            if (manifest) {
                fetchAndDecrypt(manifest);
            } else {
                alert('رابط manifest غير متوفر.');
            }
        });
    </script>
</body>
</html>
