<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Test Decryption</title>
</head>
<body>
    <script>
        // استخراج المعلمات من الرابط باستخدام URLSearchParams
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                manifest: params.get('manifest')  // استخراج المعامل "manifest"
            };
        }

        async function fetchAndDecrypt(manifestUrl) {
            try {
                // تحقق من الرابط
                if (!manifestUrl) {
                    alert('فشل: رابط manifest غير متوفر.');
                    return;
                }
                alert('الخطوة 1: رابط manifest متوفر.');

                // إرسال الطلب مع الرؤوس المطلوبة
                alert('الخطوة 2: يتم الآن إرسال الطلب إلى الرابط...');
                const response = await fetch(manifestUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'okhttp/3.12.8'
                    }
                });

                // تحقق من نجاح الطلب
                if (!response.ok) {
                    alert(`فشل: الطلب لم ينجح. رمز الحالة: ${response.status}`);
                    return;
                }
                alert('الخطوة 3: الطلب نجح. تم الحصول على الاستجابة.');

                // الحصول على النص المشفر والترويسة
                const encryptedText = await response.text();
                alert('الخطوة 4: تم الحصول على النص المشفر.');

                // الحصول على الترويسة "t"
                const headerT = response.headers.get('t');
                if (!headerT) {
                    alert('فشل: الترويسة "t" غير موجودة في الاستجابة.');
                    return;
                }
                alert('الخطوة 5: الترويسة "t" متوفرة.');

                // بناء المفتاح باستخدام الترويسة
                const key = "c!xZj+N9&G@Ev@vw" + headerT;
                alert('الخطوة 6: المفتاح تم إنشاؤه بنجاح.');

                // فك التشفير باستخدام XOR
                alert('الخطوة 7: يتم الآن فك التشفير...');
                const decodedBytes = atob(encryptedText); // فك تشفير Base64
                if (!decodedBytes) {
                    alert('فشل: لا يمكن فك تشفير النص المشفر.');
                    return;
                }

                const resultBytes = new Uint8Array(decodedBytes.length);
                for (let i = 0; i < decodedBytes.length; i++) {
                    resultBytes[i] = decodedBytes.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                }

                // تحويل النص المفكوك إلى صيغة نصية
                const decryptedText = new TextDecoder().decode(resultBytes);
                alert('الخطوة 8: فك التشفير تم بنجاح.');

                // عرض النص المفكوك في مربع نص قابل للنسخ
                const textArea = document.createElement('textarea');
                textArea.value = decryptedText;
                document.body.appendChild(textArea);

                // إضافة زر نسخ النص
                const copyButton = document.createElement('button');
                copyButton.textContent = 'نسخ النص المفكوك';
                copyButton.onclick = () => {
                    textArea.select();
                    document.execCommand('copy');
                    alert('تم نسخ النص!');
                };
                document.body.appendChild(copyButton);

            } catch (error) {
                alert(`خطأ أثناء المعالجة: ${error.message}`);
            }
        }

        // تشغيل العملية عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const { manifest } = getQueryParams();
            alert(`رابط manifest: ${manifest}`); // عرض الرابط للمراجعة
            if (manifest) {
                fetchAndDecrypt(manifest);
            } else {
                alert('رابط manifest غير متوفر.');
            }
        });
    </script>
</body>
</html>
